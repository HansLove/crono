<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Tasks Schedule</title>
  <style>
    :root{
      --bg:#0b0b0c; --panel:#121316; --muted:#8b8d92; --text:#e9eaec;
      --line:#1b1c20; --gray:#9ca3af;
      --purple:#a78bfa; --green:#34d399; --orange:#f59e0b; --yellow:#facc15; --teal:#14b8a6; --blue:#60a5fa; --default:#9ca3af;
    }
    *{box-sizing:border-box}
    html,body{height:100%}
    body{
      margin:0; background: radial-gradient(1200px 600px at 80% -10%, #1a1b20 0%, #0b0b0c 45%, #0b0b0c 100%);
      color:var(--text); font:14px/1.45 system-ui, -apple-system, Segoe UI, Roboto, Inter, Helvetica, Arial, sans-serif;
    }
    .wrap{max-width:1100px; margin:40px auto; padding:0 16px}
    header{display:flex; gap:12px; align-items:end; justify-content:space-between; margin-bottom:16px}
    h1{margin:0; font-size:22px; letter-spacing:.2px}
    .sub{color:var(--muted); font-size:12px}
    .controls{display:flex; gap:8px; flex-wrap:wrap}
    .input, .select{
      background:#0f1013; border:1px solid var(--line); color:var(--text);
      padding:10px 12px; border-radius:12px; outline:none; min-width:220px;
    }
    .board{display:grid; gap:12px}
    .card{
      background:linear-gradient(180deg, #14161a 0%, #0f1014 100%); border:1px solid var(--line);
      border-radius:16px; padding:14px; box-shadow: 0 10px 30px rgba(0,0,0,.35);
    }
    .row1{display:flex; align-items:center; gap:10px; flex-wrap:wrap; justify-content:space-between}
    .left{display:flex; align-items:center; gap:10px; min-width:0}
    .dot{width:10px; height:10px; border-radius:50%}
    .key{font-weight:500; color:#8b8d92; letter-spacing:.2px; font-size:11px; background:#1b1c20; padding:2px 6px; border-radius:4px}
    .sum{color:#e9eaec; overflow:hidden; text-overflow:ellipsis; white-space:nowrap; max-width:520px; font-size:15px; font-weight:500}
    .badges{display:flex; gap:6px; flex-wrap:wrap}
    .badge{
      border:1px solid var(--line); color:var(--muted); padding:4px 8px; border-radius:999px; font-size:11px
    }
    .row2{margin-top:12px}
    .bar{
      position:relative; height:20px; background:#0d0e11; border:1px solid var(--line);
      border-radius:999px; overflow:hidden; display:flex; align-items:center; justify-content:center;
    }
    .fill{position:absolute; inset:0 auto 0 0; background:linear-gradient(90deg, #5865f2, #38bdf8);
      width:0%; transition:width .6s ease; }
    .today{position:absolute; top:-6px; bottom:-6px; width:2px; background:#ffffff20}
    .bar-text{position:absolute; color:#fff; font-weight:700; font-size:12px; z-index:2; text-shadow:0 0 3px rgba(0,0,0,0.8)}
    .row3{display:flex; align-items:center; justify-content:space-between; color:var(--muted); margin-top:8px; font-size:12px}
    .dates{display:flex; gap:12px; align-items:center; flex-wrap:wrap}
    .count{font-feature-settings: "tnum" 1, "opsz" 144; color:#fff; font-weight:700; font-size:16px}
    .pill{
      border:1px dashed #2a2c33; color:#aab; padding:3px 8px; border-radius:999px; font-size:11px
    }
    .warn{color:#ffd166}
    .late{color:#ff7b7b}
    .gas-cost{font-weight:700; color:#34d399; font-size:18px; background:#0f2b1f; padding:4px 8px; border-radius:6px; border:1px solid #34d39940}
    .calendar-btn{background:#5865f2; color:#fff; border:none; padding:6px 12px; border-radius:6px; font-size:11px; font-weight:600; cursor:pointer; transition:all 0.2s}
    .calendar-btn:hover{background:#4752c4; transform:translateY(-1px)}
    footer{margin-top:18px; color:var(--muted); font-size:11px}
    .empty{color:var(--muted); text-align:center; padding:40px 0; border:1px dashed var(--line); border-radius:12px}
    @media (max-width:700px){ 
      .sum{max-width:260px}
      .gas-cost{font-size:16px; padding:3px 6px}
      .calendar-btn{font-size:10px; padding:4px 8px}
      .badges{flex-direction:column; align-items:flex-end; gap:4px}
      .badges .gas-cost{order:-1; margin-bottom:4px}
    }
  </style>
</head>
<body>
  <div class="wrap">
    <header>
      <div>
        <h1>Schedule â€” E</h1>
        <div class="sub">Public view (read-only) Â· Live updates remaining time</div>
      </div>
      <div class="controls">
        <input class="input" id="q" placeholder="Filter by key, summary, status, assigneeâ€¦" />
        <select class="select" id="status">
          <option value="">All statuses</option>
          <option>To Do</option>
          <option>In Progress</option>
          <option>Completed</option>
        </select>
      </div>
    </header>

    <div id="board" class="board"></div>
    <div id="empty" class="empty" style="display:none">No items to display.</div>
    <footer id="stamp">Syncingâ€¦</footer>
  </div>

  <script>
    // === Config ===
    // Link to the "Crono" tab (with gid). Keep single=true&output=csv.
    const CSV_URL = "https://docs.google.com/spreadsheets/d/e/2PACX-1vQxNrV687aUqrPHpPxy8oVNjUvilP2Nt76FI6CByIOmShtve6BnsB_JUb317Mb86faVkB0ulWPNof-J/pub?gid=0&single=true&output=csv";
    const CORS_PROXY = "https://api.allorigins.win/raw?url=";
    const REFRESH_SEC = 120;               // smooth CSV refresh
    const TIMEZONE = "America/Tijuana";    // your timezone
    
    // Fallback data in case CSV fetch fails
    const FALLBACK_DATA = [
      {
        key: "LHR-70",
        type: "Epic",
        sum: "Automatic change of device. Leads generation",
        state: "Por Hacer",
        assg: "",
        start: new Date("2025-09-06"),
        due: new Date("2025-09-30"),
        color: "#34d399",
        gas: 3232
      },
      {
        key: "LHR-71",
        type: "Epic", 
        sum: "250 people Broadcast test",
        state: "Por Hacer",
        assg: "",
        start: new Date("2025-09-28"),
        due: new Date("2025-10-06"),
        color: "#14b8a6",
        gas: 4324
      },
      {
        key: "LHR-72",
        type: "Epic",
        sum: "Affill new payment channel integration",
        state: "Por Hacer",
        assg: "",
        start: new Date("2025-09-19"),
        due: new Date("2025-10-02"),
        color: "#a78bfa",
        gas: 5454
      },
      {
        key: "LHR-73",
        type: "Epic",
        sum: "Lich Coding new version for Fintech and budgets",
        state: "Por Hacer",
        assg: "",
        start: new Date("2025-10-01"),
        due: new Date("2025-10-14"),
        color: "#a78bfa",
        gas: 354
      }
    ];

    // Colors by "Issue color" from the sheet (keywords)
    const COLORS = {
      purple:"#a78bfa", green:"#34d399", orange:"#f59e0b", yellow:"#facc15",
      dark_orange:"#ff8c42", dark_teal:"#14b8a6", blue:"#60a5fa",
      default:"#9ca3af"
    };

    // === Helpers ===
    const fmtDate = (d) => d ? d.toLocaleDateString("en-US", { timeZone: TIMEZONE }) : "â€”";
    const clamp = (x, a, b) => Math.max(a, Math.min(b, x));
    const msToParts = (ms) => {
      const neg = ms < 0; let m = Math.abs(ms);
      const d = Math.floor(m / 86400000); m -= d*86400000;
      const h = Math.floor(m / 3600000);  m -= h*3600000;
      const n = Math.floor(m / 60000);    m -= n*60000;
      const s = Math.floor(m / 1000);
      return {neg, d, h, n, s};
    };
    const partsToStr = (p) => `${p.neg ? "-" : ""}${String(p.d).padStart(2,"0")}d:${String(p.h).padStart(2,"0")}h:${String(p.n).padStart(2,"0")}m:${String(p.s).padStart(2,"0")}s`;
    const safe = (v) => (v || "").trim();
    
    // Calendar integration
    const addToCalendar = (item) => {
      const startDate = item.start ? item.start.toISOString().split('T')[0] : new Date().toISOString().split('T')[0];
      const endDate = item.due ? item.due.toISOString().split('T')[0] : startDate;
      const title = `${item.key} - ${item.sum}`;
      const details = `Budget: $${item.gas.toLocaleString()}\nStatus: ${item.state}\nAssignee: ${item.assg || 'Unassigned'}`;
      
      // Create Google Calendar URL
      const googleUrl = `https://calendar.google.com/calendar/render?action=TEMPLATE&text=${encodeURIComponent(title)}&dates=${startDate}/${endDate}&details=${encodeURIComponent(details)}`;
      
      // Create ICS file for other calendar apps
      const icsContent = `BEGIN:VCALENDAR
VERSION:2.0
PRODID:-//Task Scheduler//EN
BEGIN:VEVENT
UID:${item.key}-${Date.now()}@crono.local
DTSTAMP:${new Date().toISOString().replace(/[-:]/g, '').split('.')[0]}Z
DTSTART:${startDate.replace(/-/g, '')}
DTEND:${endDate.replace(/-/g, '')}
SUMMARY:${title}
DESCRIPTION:${details.replace(/\n/g, '\\n')}
STATUS:CONFIRMED
END:VEVENT
END:VCALENDAR`;
      
      // Try to open Google Calendar first
      window.open(googleUrl, '_blank');
      
      // Also provide download option for ICS
      const blob = new Blob([icsContent], { type: 'text/calendar' });
      const url = URL.createObjectURL(blob);
      const a = document.createElement('a');
      a.href = url;
      a.download = `${item.key}-calendar.ics`;
      document.body.appendChild(a);
      a.click();
      document.body.removeChild(a);
      URL.revokeObjectURL(url);
    };

    // Dates from CSV come as "YYYY/MM/DD"
    const fixDate = (s) => {
      if (!s) return null;
      const t = s.trim();
      // Handle YYYY/MM/DD format directly
      const d = new Date(t);
      return isNaN(d) ? null : d;
    };

    // CSV/TSV parser (simple, supports quotes and tabs)
    function parseCSV(text){
      const rows=[]; let row=[], cur="", inQ=false;
      for(let i=0;i<text.length;i++){
        const c=text[i], n=text[i+1];
        if (inQ){
          if (c === '"' && n === '"'){ cur+='"'; i++; }
          else if (c === '"'){ inQ=false; }
          else { cur+=c; }
        } else {
          if (c === '"'){ inQ=true; }
          else if (c === '\t' || c === ','){ row.push(cur); cur=""; }
          else if (c === '\n'){ row.push(cur); rows.push(row); row=[]; cur=""; }
          else if (c === '\r'){ /* skip */ }
          else { cur+=c; }
        }
      }
      if (cur.length || row.length) { row.push(cur); rows.push(row); }
      return rows;
    }

    function mapIssueColor(name){
      if (!name) return COLORS.default;
      const k = String(name).toLowerCase().trim();
      return COLORS[k] || COLORS.default;
    }

    // === State ===
    let DATA = [];
    let FILTERED = [];
    let TIMER = null;
    let LAST_SYNC = null;
    let nextRefreshAt = null;

    // === Fetch + Transform ===
    async function loadCSV(){
      try {
        // Try direct fetch first
        let res, txt;
        try {
          res = await fetch(CSV_URL, { cache:"no-store" });
          if (!res.ok) throw new Error(`Direct fetch failed: ${res.status}`);
          txt = await res.text();
        } catch (directError) {
          console.log("Direct fetch failed, trying CORS proxy...", directError.message);
          // Try with CORS proxy
          res = await fetch(CORS_PROXY + encodeURIComponent(CSV_URL), { cache:"no-store" });
          if (!res.ok) throw new Error(`CORS proxy fetch failed: ${res.status}`);
          txt = await res.text();
        }
        
        const rows = parseCSV(txt);

        if (!rows.length) {
          console.log("No data in CSV, using fallback data");
          return FALLBACK_DATA;
        }
        
        const header = rows[0].map(h => h.trim());
        const idx = (name) => header.findIndex(h => h.toLowerCase() === name.toLowerCase());

        const iKey   = idx("Clave");
        const iType  = idx("Tipo de Incidencia");
        const iSum   = idx("Resumen");
        const iState = idx("Estado");
        const iAssg  = idx("Persona asignada");
        const iStart = idx("Start date");
        const iStartD= idx("Fecha de inicio deducida");
        const iDue   = idx("Fecha de vencimiento");
        const iDueD  = idx("Fecha de vencimiento deducida");
        const iCol   = idx("Issue color");
        const iGas   = idx("Gas");

        const out = [];
        for (let r=1; r<rows.length; r++){
          const row = rows[r];
          if (!row || !row.length) continue;

          const key   = safe(row[iKey]);
          const type  = safe(row[iType]);
          const sum   = safe(row[iSum]);
          const state = safe(row[iState]);
          const assg  = safe(row[iAssg]);
          const startTxt = safe(row[iStartD] || row[iStart]);
          const dueTxt   = safe(row[iDueD]   || row[iDue]);
          const start = fixDate(startTxt);
          const due   = fixDate(dueTxt);
          const color = mapIssueColor(safe(row[iCol]));
          const gas   = parseFloat(safe(row[iGas])) || 0;

          if (!key && !sum) continue;
          out.push({ key, type, sum, state, assg, start, due, color, gas });
        }

        // Sort by due date ascending
        out.sort((a,b)=>{
          const ax = a.due ? a.due.getTime():Infinity;
          const bx = b.due ? b.due.getTime():Infinity;
          return ax - bx;
        });
        return out;
      } catch (error) {
        console.error("Error loading CSV:", error);
        console.log("Using fallback data due to error");
        return FALLBACK_DATA;
      }
    }

    // === Render ===
    function render(){
      const board = document.getElementById("board");
      const empty = document.getElementById("empty");
      board.innerHTML = "";

      const q = document.getElementById("q").value.trim().toLowerCase();
      const st = document.getElementById("status").value;

      FILTERED = DATA.filter(it=>{
        const matchQ = !q || [it.key, it.sum, it.state, it.assg].some(v => (v||"").toLowerCase().includes(q));
        const matchS = !st || (it.state||"") === st;
        return matchQ && matchS;
      });

      if (!FILTERED.length){
        empty.style.display = "block";
        return;
      } else empty.style.display = "none";

      const now = Date.now();

      FILTERED.forEach(it=>{
        const startMs = it.start ? it.start.getTime() : now;
        const dueMs   = it.due ? it.due.getTime() : now + 1;
        const span = Math.max(1, dueMs - startMs);
        const pct = Math.round(100 * clamp(now - startMs, 0, span) / span);
        const daysLeft = Math.ceil((dueMs - now) / 86400000);

        const card = document.createElement("div");
        card.className = "card";
        card.innerHTML = `
          <div class="row1">
            <div class="left">
              <span class="dot" style="background:${it.color}"></span>
              <span class="key">${it.key || "â€”"}</span>
              <span class="sum" title="${it.sum || ""}">Â· ${it.sum || ""}</span>
            </div>
            <div class="badges">
              <span class="gas-cost">$${it.gas.toLocaleString()}</span>
              ${it.state ? `<span class="badge">${it.state}</span>` : ""}
              ${it.assg ? `<span class="badge">ðŸ‘¤ ${it.assg}</span>` : ""}
              ${it.type ? `<span class="badge">${it.type}</span>` : ""}
              ${Number.isFinite(daysLeft) ? `<span class="badge">ðŸ“… ${daysLeft >= 0 ? daysLeft+'d remaining' : Math.abs(daysLeft)+'d overdue'}</span>` : ""}
              <button class="calendar-btn" onclick="addToCalendar(${JSON.stringify(it).replace(/"/g, '&quot;')})">ðŸ“… Add to Calendar</button>
            </div>
          </div>
          <div class="row2">
            <div class="bar">
              <div class="fill" style="width:${isFinite(pct) ? pct : 0}%; background:${it.color};"></div>
              <div class="bar-text">${isFinite(pct) ? pct : 0}%</div>
              ${(it.start && it.due) ? `<div class="today" style="left:${clamp(100*(now - startMs)/span,0,100)}%;"></div>` : ""}
            </div>
          </div>
          <div class="row3">
            <div class="dates">
              <span class="pill">Start: ${fmtDate(it.start)}</span>
              <span class="pill">Due: ${fmtDate(it.due)}</span>
            </div>
            <div class="count" data-key="${it.key}">â€”</div>
          </div>
        `;
        board.appendChild(card);
      });

      if (TIMER) clearInterval(TIMER);
      TIMER = setInterval(updateCountdowns, 1000);
      updateCountdowns();
    }

    function updateCountdowns(){
      const now = Date.now();
      FILTERED.forEach(it=>{
        const dueMs = it.due ? it.due.getTime() : now;
        const delta = dueMs - now;
        const el = document.querySelector(`.count[data-key="${CSS.escape(it.key)}"]`);
        if (!el) return;
        const p = msToParts(delta);
        el.textContent = partsToStr(p);
        el.classList.toggle("late", delta < 0);
        el.classList.toggle("warn", delta >= 0 && delta <= 3*86400000);
      });
      const stamp = document.getElementById("stamp");
      if (LAST_SYNC) {
        const left = nextRefreshAt ? Math.max(0, Math.round((nextRefreshAt - Date.now())/1000)) : REFRESH_SEC;
        stamp.textContent = `Updated: ${LAST_SYNC.toLocaleString("en-US", { timeZone: TIMEZONE })} Â· Next refresh in ~${left}s`;
      }
    }

    async function bootstrap(){
      try{
        DATA = await loadCSV();
        LAST_SYNC = new Date();
        nextRefreshAt = Date.now() + REFRESH_SEC*1000;
        render();
        
        // Update status message
        const stamp = document.getElementById("stamp");
        if (DATA === FALLBACK_DATA) {
          stamp.textContent = "Using fallback data (offline mode)";
        } else {
          const left = nextRefreshAt ? Math.max(0, Math.round((nextRefreshAt - Date.now())/1000)) : REFRESH_SEC;
          stamp.textContent = `Updated: ${LAST_SYNC.toLocaleString("en-US", { timeZone: TIMEZONE })} Â· Next refresh in ~${left}s`;
        }
      }catch(e){
        console.error(e);
        const empty = document.getElementById("empty");
        empty.style.display = "block";
        empty.textContent = `Error: ${e.message}`;
        const stamp = document.getElementById("stamp");
        stamp.textContent = `Error loading data: ${e.message}`;
      }finally{
        setTimeout(bootstrap, REFRESH_SEC*1000);
      }
    }

    document.getElementById("q").addEventListener("input", render);
    document.getElementById("status").addEventListener("change", render);

    bootstrap();
  </script>
</body>
</html>
